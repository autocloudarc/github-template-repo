---
agent: agent
model: Claude Haiku 4.5 (copilot)
name: 2.01-create-csv-test-dataset
description: Refactor the xUnit test project to use a CSV file as the data source for test cases.
---

# Create CSV Test Dataset

Refactor the existing xUnit test project for the .NET 10 console calculator application to utilize a CSV file as the data source for test cases.
For the test data sets, use the existing values but refactor the test to source these values from a well-structured and formatted CSV file, with columns showing firstNumber, secondNumber, Operation, expectedValue, actualValue, result. 

Create a new folder named `TestData` inside the test project directory at: "$(git rev-parse --show-toplevel)\programming\dotnet\csharp\workspace\calculator-xunit-testing\calculator.tests". Place the CSV file named `CalculatorTestData.csv` inside this folder.
Update the test methods to read from this CSV file and execute the tests accordingly. Ensure that the tests validate the calculator operations (addition, subtraction, multiplication, division, modulo, exponent) using the data from the CSV file.
Ensure that the CSV file is properly formatted and includes headers for clarity. The test methods should parse the CSV file and use the data to perform the calculations and assertions.

## Implementation Findings & Workarounds

### Critical Discoveries from Session Execution

**1. MemberData Visibility Requirement**
- **Error**: `xUnit1016: MemberData must reference a public member`
- **Issue**: The data provider method `LoadTestDataFromCsv()` was declared as `private static`
- **Solution**: Change to `public static` visibility. xUnit requires MemberData attributes to reference public methods only
- **Example**: `public static IEnumerable<object[]> LoadTestDataFromCsv()`

**2. CSV File Path Resolution**
- **Issue**: CSV file location at runtime differs from project structure
- **Solution**: Use `AppContext.BaseDirectory` to locate the CSV file in the output directory:
  ```csharp
  private static readonly string TestDataPath = Path.Combine(
      AppContext.BaseDirectory,
      "TestData",
      "CalculatorTestData.csv"
  );
  ```
- **Why**: Build output directory structure differs from source directory; CSV must be copied during build

**3. CSV File Copy Configuration in .csproj**
- **Required**: Add CSV file to project with output copy instruction:
  ```xml
  <ItemGroup>
    <None Update="TestData\CalculatorTestData.csv">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </None>
  </ItemGroup>
  ```
- **Without this**: CSV file won't be available to tests at runtime

**4. CSV Column Headers**
- **Recommended columns**: firstNumber, secondNumber, operator, expectedResult, testDescription
- **Note**: Include testDescription for test clarity and debugging; helps identify which test case failed
- **Format**: CSV should include a header row; skip it with `.Skip(1)` when reading

**5. Floating-Point Precision for Division and Power Operations**
- **Issue**: Direct equality comparison fails for division and power results (floating-point precision errors)
- **Solution**: Use precision parameter in Assert.Equal():
  ```csharp
  if (op == "^" || op == "/")
  {
      Assert.Equal(expectedResult, result, precision: 10);
  }
  else
  {
      Assert.Equal(expectedResult, result);
  }
  ```

**6. CSV Data Parsing Implementation**
- **Recommended approach**: Create a public static method that yields test data:
  ```csharp
  public static IEnumerable<object[]> LoadTestDataFromCsv()
  {
      if (!File.Exists(TestDataPath))
          throw new FileNotFoundException($"Test data file not found: {TestDataPath}");

      var lines = File.ReadAllLines(TestDataPath);
      
      foreach (var line in lines.Skip(1))
      {
          if (string.IsNullOrWhiteSpace(line)) continue;
          
          var parts = line.Split(',');
          if (parts.Length < 5) continue;

          yield return new object[]
          {
              double.Parse(parts[0].Trim()),
              double.Parse(parts[1].Trim()),
              parts[2].Trim(),
              double.Parse(parts[3].Trim()),
              parts[4].Trim()
          };
      }
  }
  ```

**7. Test Organization Pattern**
- **Best Practice**: Combine CSV-driven tests with individual operation tests:
  - CSV-driven tests validate all operations with data-driven approach
  - Individual tests ensure error conditions (division by zero, null operators, etc.) are properly tested
  - Error tests cannot be easily data-driven and are better as explicit Fact tests

### Implementation Checklist

- ✅ Create TestData folder inside calculator.tests project
- ✅ Create CalculatorTestData.csv with proper headers (firstNumber, secondNumber, operator, expectedResult, testDescription)
- ✅ Add CSV file copy configuration to .csproj
- ✅ Create public static LoadTestDataFromCsv() method
- ✅ Use AppContext.BaseDirectory for file path resolution
- ✅ Implement MemberData-driven theory test
- ✅ Apply precision handling for floating-point operations
- ✅ Maintain individual operation tests for edge cases
- ✅ Verify all tests pass with `dotnet test`

### Test Coverage Results

Expected results after implementation:
- **CSV-driven tests**: 33 tests (covers all operations with various inputs)
- **Individual operation tests**: 14 tests (covers error conditions and core functionality)
- **Total**: 47 tests passing
- **Duration**: ~33ms
- **Success rate**: 0 failed